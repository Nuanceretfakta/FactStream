"""
Decision engine for handling incoming cases.

Problem:
Organisationer bruger for meget tid p√• at vurdere,
om en sag kan h√•ndteres automatisk eller kr√¶ver manuel behandling.
Beslutninger bliver inkonsistente og afh√¶nger af, hvem der l√¶ser sagen.

L√∏sning:
Dette script formaliserer beslutningslogikken.
Hver sag vurderes ud fra klare regler og klassificeres som
AUTO eller MANUEL ‚Äì altid med en tydelig begrundelse.

Form√•l:
- Ensartede beslutninger
- Klar dokumentation af hvorfor en sag behandles manuelt
- Klar til brug i automation (Zapier / Make / Microsoft)
"""

from typing import Dict, List, Tuple


def normalize(text: str) -> str:
    """Normalize free text input for stable comparisons."""
    return (text or "").strip()


def description_is_unclear(text: str) -> bool:
    """
    Simple heuristic:
    A description is considered unclear if it is too short
    or overly generic.
    """
    t = normalize(text).lower()
    generic = {"hj√¶lp", "help", "ved ikke", "ok", "problem", "fejl", "virker ikke"}
    return len(t) < 15 or t in generic


def decide(case: Dict) -> Tuple[str, str]:
    """
    Core decision logic.

    Returns:
    - decision: 'AUTO' or 'MANUEL'
    - reason: short explanation
    """
    priority = normalize(case.get("prioritet", "Middel")).capitalize()
    description = normalize(case.get("beskrivelse", ""))
    email = normalize(case.get("email", ""))

    reasons = []

    if priority == "H√∏j":
        reasons.append("h√∏j prioritet")

    if description_is_unclear(description):
        reasons.append("uklar beskrivelse")

    if not email:
        reasons.append("mangler email")

    if reasons:
        return "MANUEL", ", ".join(reasons)

    return "AUTO", "klar sag uden h√∏j prioritet"


def main() -> None:
    # Example cases (simulating form or webhook input)
    cases: List[Dict] = [
        {
            "navn": "Anna",
            "prioritet": "Lav",
            "email": "anna@firma.dk",
            "beskrivelse": "Jeg vil gerne √¶ndre min l√∏ntr√¶kprocent.",
        },
        {
            "navn": "Jonas",
            "prioritet": "H√∏j",
            "email": "jonas@firma.dk",
            "beskrivelse": "Systemet fejler ved login med MitID.",
        },
        {
            "navn": "Mads",
            "prioritet": "Middel",
            "email": "mads@firma.dk",
            "beskrivelse": "Hj√¶lp",
        },
    ]

    print("\nüß† Decision engine ‚Äì AUTO vs MANUEL\n")

    for i, case in enumerate(cases, start=1):
        decision, reason = decide(case)
        print(f"Sag {i}: {decision} ({reason})")

    print()


if __name__ == "__main__":
    main()
