# Day 40 ‚Äì data prep for reporting (Power BI / Excel)

import csv
from collections import defaultdict
from pathlib import Path

INPUT_CSV = "sharepoint_export.csv"

ALLOWED_PRIORITIES = {"Lav", "Middel", "H√∏j"}


def normalize(text: str) -> str:
    return (text or "").strip()


def read_cases(path: str) -> list[dict]:
    """
    Reads a simulated SharePoint export CSV.
    Expected columns: Afdeling, Hast (case-insensitive, spaces tolerated)
    """
    cases = []

    with open(path, newline="", encoding="utf-8") as f:
        reader = csv.DictReader(f, skipinitialspace=True)

        if reader.fieldnames is None:
            return []

        # Normalize headers
        reader.fieldnames = [h.strip() for h in reader.fieldnames]
        headers_lower = {h.lower(): h for h in reader.fieldnames}

        # Allow a bit of messiness in exports (case differences)
        if "afdeling" not in headers_lower or "hast" not in headers_lower:
            raise ValueError(
                f"CSV mangler kolonner.\nFandt: {reader.fieldnames}\nForventer mindst: Afdeling, Hast"
            )

        afdeling_key = headers_lower["afdeling"]
        hast_key = headers_lower["hast"]

        for row in reader:
            # Normalize row keys/values
            row = {k.strip(): (v.strip() if isinstance(v, str) else v) for k, v in row.items()}

            afdeling = normalize(row.get(afdeling_key, ""))
            hast = normalize(row.get(hast_key, ""))

            if not afdeling or not hast:
                continue

            cases.append({"Afdeling": afdeling, "Hast": hast})

    return cases


def summarize(cases: list[dict]) -> tuple[dict[str, int], dict[str, dict[str, int]]]:
    """
    Returns:
    - count_by_department: {Afdeling: count}
    - count_by_department_priority: {Afdeling: {Hast: count}}
    """
    count_by_department = defaultdict(int)
    count_by_department_priority = defaultdict(lambda: defaultdict(int))

    for c in cases:
        dept = c["Afdeling"]
        prio = c["Hast"]

        count_by_department[dept] += 1
        count_by_department_priority[dept][prio] += 1

    return dict(count_by_department), {d: dict(p) for d, p in count_by_department_priority.items()}


def main() -> None:
    input_file = Path(INPUT_CSV)
    if not input_file.exists():
        print(f"‚ùå Mangler inputfil: {INPUT_CSV}")
        print("‚û°Ô∏è L√¶g en CSV i samme mappe (kolonner: Afdeling, Hast)")
        return

    cases = read_cases(INPUT_CSV)

    if not cases:
        print("Ingen data i dag")
        return

    count_by_dept, count_by_dept_prio = summarize(cases)

    # Total high priority
    total_high = sum(prios.get("H√∏j", 0) for prios in count_by_dept_prio.values())

    print("\nüìä Day 40 ‚Äì Rapport-overblik (klar til Power BI / Excel)\n")

    print("Antal sager pr. afdeling:")
    for dept, count in sorted(count_by_dept.items(), key=lambda x: x[1], reverse=True):
        print(f"- {dept}: {count}")

    print("\nAntal h√∏j-prio sager:")
    print(f"- Samlet: {total_high}")

    for dept in sorted(count_by_dept.keys()):
        high = count_by_dept_prio.get(dept, {}).get("H√∏j", 0)
        print(f"- {dept}: {high}")

    print()


if __name__ == "__main__":
    main()
